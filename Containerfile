# SPDX-License-Identifier: PMPL-1.0-or-later
# Multi-stage Containerfile for Podman
# Deno + Rust/WASM + Haskell
# Base images: cgr.dev/chainguard/wolfi-base (Chainguard)

# Stage 1: Build Rust WASM modules
FROM cgr.dev/chainguard/wolfi-base:latest AS wasm-builder

RUN apk add --no-cache rust cargo musl-dev

WORKDIR /build

# Install wasm target
RUN rustup target add wasm32-unknown-unknown

# Copy Rust source
COPY wasm-modules/Cargo.toml wasm-modules/Cargo.lock* ./
COPY wasm-modules/src ./src

# Build WASM
RUN cargo build --release --target wasm32-unknown-unknown

# Stage 2: Build Haskell validator
FROM cgr.dev/chainguard/wolfi-base:latest AS haskell-builder

RUN apk add --no-cache ghc cabal-install

WORKDIR /validator

# Copy Haskell source
COPY validator/validator-bridge.cabal ./
COPY validator/*.hs ./

# Build Haskell validator
RUN cabal update && \
    cabal build && \
    cabal install --installdir=/usr/local/bin

# Stage 3: Final runtime image with Deno
FROM cgr.dev/chainguard/wolfi-base:latest

RUN apk add --no-cache deno ca-certificates tini curl

WORKDIR /app

# Copy WASM modules
COPY --from=wasm-builder /build/target/wasm32-unknown-unknown/release/recon_wasm.wasm ./src/wasm/hasher.wasm

# Copy Haskell validator
COPY --from=haskell-builder /usr/local/bin/validator-bridge /usr/local/bin/

# Copy Deno source and configuration
COPY deno.json deno.lock* ./
COPY src ./src
COPY scripts ./scripts

# Cache Deno dependencies
RUN deno cache --lock=deno.lock src/main.js

# Copy configuration files
COPY justfile ./
COPY examples ./examples

# Create data directory
RUN mkdir -p /data && \
    chmod 777 /data

# Set environment variables
ENV DENO_DIR=/deno-dir
ENV ARANGO_URL=http://arangodb:8529
ENV ARANGO_DATABASE=reconciliation

# Use tini as init system
ENTRYPOINT ["/sbin/tini", "--"]

# Default command
CMD ["deno", "run", "--allow-all", "src/main.js", "help"]

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD deno eval "console.log('healthy')" || exit 1

# Labels
LABEL org.opencontainers.image.title="recon-silly-ation"
LABEL org.opencontainers.image.description="Documentation Reconciliation System (Deno + WASM)"
LABEL org.opencontainers.image.version="0.3.0"
LABEL org.opencontainers.image.authors="Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>"
LABEL org.opencontainers.image.source="https://github.com/hyperpolymath/recon-silly-ation"
LABEL org.opencontainers.image.licenses="PMPL-1.0-or-later"
